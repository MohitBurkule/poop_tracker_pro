<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Poop Tracker Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
  <style>
    :root {
      --primary-color: #8BC34A;
      --secondary-color: #FFEB3B;
      --background: #F5F5F5;
      --text-color: #333;
      --card-bg: #FFFFFF;
      --box-shadow-color: rgba(0, 0, 0, 0.1);
    }

    /* Base styling */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background);
      color: var(--text-color);
    }

    h1 {
      text-align: center;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
      margin-top: 0;
    }

    /* NAVIGATION - Desktop top bar */
    nav.top-nav {
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px var(--box-shadow-color);
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    nav.top-nav a {
      cursor: pointer;
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      padding: 8px 16px;
      border-radius: 5px;
      transition: all 0.3s;
    }
    nav.top-nav a:hover {
      background: var(--primary-color);
      color: #fff;
    }

    /* NAVIGATION - Mobile bottom bar */
    nav.bottom-nav {
      display: none; /* hidden by default on desktop */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      box-shadow: 0 -2px 5px var(--box-shadow-color);
      padding: 0.5rem 0;
      justify-content: space-around;
      align-items: center;
      z-index: 999;
    }
    nav.bottom-nav a {
      text-decoration: none;
      color: var(--primary-color);
      font-size: 1.4rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    nav.bottom-nav a span {
      font-size: 0.7rem; /* label under the icon */
      margin-top: 2px;
    }

    /* Hide top nav on mobile, show bottom nav */
    @media (max-width: 600px) {
      nav.top-nav {
        display: none;
      }
      nav.bottom-nav {
        display: flex;
      }
      body {
        padding-bottom: 60px; /* so content isn't behind bottom nav */
      }
    }

    .page {
      display: none;
    }
    .active-page {
      display: block;
    }

    .card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 2px 10px var(--box-shadow-color);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 1.3rem;
    }

    label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 500;
    }

    /* Ensure inputs, selects, textareas fit well on mobile */
    input[type='text'],
    input[type='datetime-local'],
    select,
    textarea {
      width: 100%;
      max-width: 100%;
      padding: 0.7rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.7rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 0.25rem;
      margin-bottom: 0.25rem;
    }
    button:hover {
      transform: translateY(-2px);
    }

    /* Calendar stuff */
    .calendar-container {
      overflow-x: auto;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 1rem;
    }

    .day {
      background: var(--card-bg);
      border: 1px solid #eee;
      padding: 0.7rem;
      min-height: 80px;
      position: relative;
      transition: all 0.3s;
      cursor: pointer;
    }
    .day:hover {
      transform: scale(1.03);
      z-index: 1;
    }
    .poop-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary-color);
      display: inline-block;
      margin: 2px;
    }
    .current-day {
      background: #E8F5E9;
      border-color: var(--primary-color);
    }

    /* Toast notification (custom "alert") */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: var(--secondary-color);
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      animation: slideIn 0.3s ease-out;
      z-index: 9999;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }
      to {
        transform: translateX(0);
      }
    }

    .chart-container {
      max-width: 600px;
      margin: 2rem auto;
      height: 400px;
    }

    .month-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-box {
      background: #fafafa;
      border-radius: 8px;
      text-align: center;
      padding: 1rem;
      box-shadow: 0 2px 5px var(--box-shadow-color);
    }

    /* Last 5 Poops list */
    .recent-poops {
      margin-top: 1.5rem;
    }
    .recent-poops h3 {
      margin-bottom: 0.5rem;
    }
    .poop-item {
      display: flex;
      justify-content: space-between;
      background: #f9f9f9;
      padding: 0.5rem;
      margin-bottom: 5px;
      border-radius: 6px;
      align-items: center;
      gap: 0.5rem;
    }
    .poop-info {
      font-size: 0.9rem;
      flex: 1;
    }

    /* Day Details Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      margin: 0;
    }
    .close-modal {
      background: transparent;
      color: #666;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }

    /* Multi-select dropdown styling */
    .multi-select-container {
      position: relative;
    }
    .multi-select-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.7rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
    }
    .multi-select-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px var(--box-shadow-color);
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      display: none;
    }
    .multi-select-options.active {
      display: block;
    }
    .multi-select-options label {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .multi-select-options input[type="checkbox"] {
      margin-right: 8px;
    }

    /* Settings: custom fields list */
    .custom-fields-list {
      margin: 1rem 0;
      background: #fafafa;
      padding: 0.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px var(--box-shadow-color);
    }
    .custom-field-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    .custom-field-item:last-child {
      border-bottom: none;
    }

    /* Edit Poop Modal */
    #edit-poop-modal .modal-content {
      width: 90%;
      max-width: 600px;
    }
  </style>
</head>
<body>

  <!-- Title visible on all devices -->
  <h1>Poop Tracker Pro</h1>

  <!-- TOP NAV (Desktop) -->
  <nav class="top-nav">
    <a onclick="showPage('track')">Track Poop</a>
    <a onclick="showPage('calendar')">Calendar</a>
    <a onclick="showPage('analysis')">Analysis</a>
    <a onclick="showPage('settings')">Settings</a>
  </nav>

  <!-- BOTTOM NAV (Mobile) -->
  <nav class="bottom-nav">
    <a onclick="showPage('track')">üí©<span>Track</span></a>
    <a onclick="showPage('calendar')">üìÖ<span>Calendar</span></a>
    <a onclick="showPage('analysis')">üìä<span>Analysis</span></a>
    <a onclick="showPage('settings')">‚öôÔ∏è<span>Settings</span></a>
  </nav>

  <!-- Track Page -->
  <div id="track" class="page active-page">
    <div class="card">
      <h2>Log New Poop</h2>
      <!-- Convert from <div> to <form> so we can use .reset() -->
      <form id="poop-form" onsubmit="return false;">
        <div class="form-group">
          <label>Date/Time</label>
          <input type="datetime-local" id="datetime" required />
        </div>

        <div class="form-group">
          <label>Color</label>
          <select id="color">
            <option value="brown">Brown</option>
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="black">Black</option>
            <option value="red">Red</option>
          </select>
        </div>

        <div class="form-group">
          <label>Consistency (Bristol Stool Scale)</label>
          <select id="consistency">
            <option value="1">Type 1 - Separate hard lumps</option>
            <option value="2">Type 2 - Lumpy sausage</option>
            <option value="3">Type 3 - Sausage with cracks</option>
            <option value="4">Type 4 - Smooth sausage</option>
            <option value="5">Type 5 - Soft blobs</option>
            <option value="6">Type 6 - Mushy</option>
            <option value="7">Type 7 - Liquid</option>
          </select>
        </div>

        <!-- Custom fields will be inserted here -->
        <div id="custom-fields"></div>

        <div class="form-group">
          <button onclick="savePoop()">Save Entry</button>
        </div>
      </form>

      <!-- Show last 5 poops -->
      <div class="recent-poops">
        <h3>Last 5 Poops:</h3>
        <div id="recent-poops-list"></div>
      </div>
    </div>
  </div>

  <!-- Calendar Page -->
  <div id="calendar" class="page">
    <div class="card">
      <div class="month-navigation">
        <button onclick="changeMonth(-1)">‚Üê Previous</button>
        <h2 id="current-month"></h2>
        <button onclick="changeMonth(1)">Next ‚Üí</button>
      </div>
      <div class="calendar-container">
        <div id="calendar-view" class="calendar"></div>
      </div>
    </div>
  </div>

  <!-- Day Details Modal -->
  <div id="day-modal" class="modal" onclick="modalBackgroundClick(event)">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="day-modal-title"></h3>
        <button class="close-modal" onclick="closeDayModal()">√ó</button>
      </div>
      <div id="day-modal-body"></div>
    </div>
  </div>

  <!-- Edit Poop Modal -->
  <div id="edit-poop-modal" class="modal" onclick="editModalBackgroundClick(event)">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Poop Entry</h3>
        <button class="close-modal" onclick="closeEditModal()">√ó</button>
      </div>
      <div id="edit-poop-form">
        <!-- We'll dynamically insert the same fields as new poop, then add a "Save Changes" button -->
      </div>
    </div>
  </div>

  <!-- Analysis Page -->
  <div id="analysis" class="page">
    <div class="card">
      <h2>Poop Analysis</h2>
      <div class="stats-grid">
        <div class="stat-box">
          <h3>üìÖ Total Entries</h3>
          <p id="total-entries">0</p>
        </div>
        <div class="stat-box">
          <h3>‚è±Ô∏è Average/Day</h3>
          <p id="daily-average">0</p>
        </div>
        <div class="stat-box">
          <h3>üé® Most Common Color</h3>
          <p id="common-color">-</p>
        </div>
        <div class="stat-box">
          <h3>üí© Common Consistency</h3>
          <p id="common-consistency">-</p>
        </div>
      </div>

      <!-- Standard Charts -->
      <div class="chart-container">
        <canvas id="consistencyChart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="timeChart"></canvas>
      </div>

      <!-- Custom Attributes Charts -->
      <div id="custom-attribute-charts"></div>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settings" class="page">
    <div class="card">
      <h2>Settings</h2>
      <p>Manage your custom attributes, and import/export your data.</p>

      <!-- Form to add custom fields -->
      <div class="form-group">
        <label for="newFieldName">Attribute Name</label>
        <input type="text" id="newFieldName" placeholder="e.g. Smell" />
      </div>
      <div class="form-group">
        <label for="newFieldType">Attribute Type</label>
        <select id="newFieldType">
          <option value="text">Text</option>
          <option value="select">Single-select (Dropdown)</option>
          <option value="multiselect">Multi-select</option>
        </select>
      </div>
      <div class="form-group">
        <label for="newFieldOptions">Options (for Single/Multi-select, comma separated)</label>
        <input
          type="text"
          id="newFieldOptions"
          placeholder="e.g. Mild,Strong,Overwhelming"
        />
      </div>
      <div class="form-group">
        <button onclick="addCustomFieldFromSettings()">Add Custom Field</button>
      </div>

      <hr />
      <!-- List existing custom fields with delete option -->
      <div>
        <h3>Existing Custom Attributes</h3>
        <div class="custom-fields-list" id="existing-custom-fields"></div>
      </div>

      <hr />
      <!-- Export / Import -->
      <div class="form-group">
        <button onclick="exportData()">Export Data</button>
      </div>
      <div class="form-group">
        <label for="importFile">Import Data (JSON):</label>
        <input type="file" id="importFile" accept=".json" />
        <button onclick="importData()">Import</button>
      </div>
    </div>
  </div>

  <script>
    const DateTime = luxon.DateTime;
    let currentMonth = DateTime.now();

    // Attempt to parse customFields from localStorage (with migration from "radio" => "select")
    let rawCustomFields = localStorage.getItem('customFields');
    let customFields = [];
    if (rawCustomFields) {
      try {
        customFields = JSON.parse(rawCustomFields);
        // Migrate old "radio" to "select"
        customFields.forEach((f) => {
          if (f.type === 'radio') {
            f.type = 'select';
          }
        });
      } catch (e) {
        customFields = [];
      }
    }

    let poopEntries = JSON.parse(localStorage.getItem('poopEntries') || '[]');
    // Ensure each poop entry has an id
    poopEntries.forEach((entry) => {
      if (!entry.id) {
        entry.id = Date.now().toString() + Math.random().toString(16).slice(2);
      }
    });
    localStorage.setItem('poopEntries', JSON.stringify(poopEntries));

    let charts = {};

    // For editing
    let editingPoopId = null; // track which poop is being edited

    // --------------------------------
    // NAVIGATION
    // --------------------------------
    function showPage(pageId) {
      document
        .querySelectorAll('.page')
        .forEach((page) => page.classList.remove('active-page'));
      document.getElementById(pageId).classList.add('active-page');

      if (pageId === 'calendar') renderCalendar();
      if (pageId === 'analysis') updateAnalysis();
      if (pageId === 'track') updateRecentPoops();
      if (pageId === 'settings') renderSettingsPage();

      // Destroy existing charts when leaving analysis page
      if (pageId !== 'analysis') {
        if (charts.consistencyChart) {
          charts.consistencyChart.destroy();
          charts.timeChart.destroy();
        }
        Object.keys(charts).forEach((key) => {
          if (key !== 'consistencyChart' && key !== 'timeChart' && charts[key]) {
            charts[key].destroy();
          }
        });
        charts = {};
      }
    }

    // --------------------------------
    // CUSTOM FIELDS
    // --------------------------------
    function addCustomFieldFromSettings() {
      const fieldName = document.getElementById('newFieldName').value.trim();
      const fieldType = document.getElementById('newFieldType').value;
      const fieldOptions = document
        .getElementById('newFieldOptions')
        .value.trim();

      if (!fieldName) {
        showNotification('Please enter a field name.');
        return;
      }

      // Check if field name already exists
      if (customFields.find((f) => f.name === fieldName)) {
        showNotification('Field name already exists!');
        return;
      }

      let optionsArray = [];
      if (fieldType === 'select' || fieldType === 'multiselect') {
        optionsArray = fieldOptions
          ? fieldOptions.split(',').map((o) => o.trim())
          : [];
        if (!optionsArray.length) {
          showNotification('Please specify options for single/multi-select.');
          return;
        }
      }

      const newField = {
        name: fieldName,
        type: fieldType,
        options: optionsArray
      };

      customFields.push(newField);
      localStorage.setItem('customFields', JSON.stringify(customFields));

      showNotification(`Custom attribute "${fieldName}" added!`);

      // Clear the form
      document.getElementById('newFieldName').value = '';
      document.getElementById('newFieldType').value = 'text';
      document.getElementById('newFieldOptions').value = '';

      renderSettingsPage();
      renderCustomFields(); // refresh track page fields
    }

    function deleteCustomField(fieldName) {
      // Check if this field has data in poopEntries
      const hasData = poopEntries.some((entry) => entry[fieldName]);
      let confirmMsg = `Are you sure you want to delete the attribute "${fieldName}"?`;
      if (hasData) {
        confirmMsg += `\n(This removes data from all existing entries!)`;
      }
      const ok = confirm(confirmMsg);
      if (!ok) return;

      // Remove from customFields
      customFields = customFields.filter((f) => f.name !== fieldName);
      localStorage.setItem('customFields', JSON.stringify(customFields));
      // Remove that attribute from all poopEntries
      poopEntries.forEach((entry) => {
        if (entry[fieldName] !== undefined) {
          delete entry[fieldName];
        }
      });
      localStorage.setItem('poopEntries', JSON.stringify(poopEntries));

      showNotification(`Deleted attribute "${fieldName}".`);
      renderSettingsPage();
      renderCustomFields(); // refresh track page fields
    }

    function renderSettingsPage() {
      // Render list of existing custom fields
      const container = document.getElementById('existing-custom-fields');
      container.innerHTML = '';

      if (customFields.length === 0) {
        container.textContent = 'No custom attributes defined.';
        return;
      }
      customFields.forEach((f) => {
        const div = document.createElement('div');
        div.className = 'custom-field-item';
        div.innerHTML = `
          <span><strong>${f.name}</strong> (${f.type}) ${
          f.options.length ? '- ' + f.options.join(', ') : ''
        }</span>
          <button style="background:#f44336" onclick="deleteCustomField('${
            f.name
          }')">Delete</button>
        `;
        container.appendChild(div);
      });
    }

    // Render custom fields on "Track Poop" page (for new poop)
    function renderCustomFields() {
      const container = document.getElementById('custom-fields');
      container.innerHTML = ''; // Clear existing

      customFields.forEach((field) => {
        container.appendChild(createFieldElement(field, `custom-${field.name}`, false));
      });
    }

    // We'll reuse this for both "new poop" and "edit poop" forms
    function createFieldElement(field, elementIdPrefix, isEdit) {
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = `<label>${field.name}</label>`;

      if (field.type === 'text') {
        div.innerHTML += `<input type="text" id="${elementIdPrefix}" />`;
      } else if (field.type === 'select') {
        let selectHtml = `<select id="${elementIdPrefix}">`;
        selectHtml += `<option value="">-- Select --</option>`;
        field.options.forEach((opt) => {
          selectHtml += `<option value="${opt}">${opt}</option>`;
        });
        selectHtml += `</select>`;
        div.innerHTML += selectHtml;
      } else if (field.type === 'multiselect') {
        const containerId = `${elementIdPrefix}-multiContainer`;
        const optionsId = `${elementIdPrefix}-multiOptions`;
        div.innerHTML += `
          <div class="multi-select-container" id="${containerId}">
            <div class="multi-select-display" onclick="toggleMultiSelect('${containerId}', '${optionsId}')">
              <span id="${containerId}-labels">Select options</span>
              <span>‚ñº</span>
            </div>
            <div class="multi-select-options" id="${optionsId}">
              ${field.options
                .map(
                  (opt) => `
                  <label>
                    <input type="checkbox" value="${opt}" onchange="updateMultiSelectLabel('${containerId}', '${optionsId}')"/>
                    ${opt}
                  </label>
                `
                )
                .join('')}
            </div>
          </div>
        `;
      }
      return div;
    }

    function toggleMultiSelect(containerId, optionsId) {
      const opts = document.getElementById(optionsId);
      opts.classList.toggle('active');
    }

    function updateMultiSelectLabel(containerId, optionsId) {
      const opts = document
        .getElementById(optionsId)
        .querySelectorAll('input[type="checkbox"]');
      const checked = [...opts].filter((c) => c.checked).map((c) => c.value);
      const labelSpan = document.getElementById(`${containerId}-labels`);
      if (checked.length === 0) {
        labelSpan.textContent = 'Select options';
      } else {
        labelSpan.textContent = checked.join(', ');
      }
    }

    function getMultiSelectValues(elementIdPrefix) {
      const containerId = `${elementIdPrefix}-multiContainer`;
      const optionsId = `${elementIdPrefix}-multiOptions`;
      const opts = document
        .getElementById(optionsId)
        .querySelectorAll('input[type="checkbox"]');
      return [...opts].filter((c) => c.checked).map((c) => c.value);
    }

    // --------------------------------
    // POOP ENTRIES
    // --------------------------------
    function savePoop() {
      const entry = {
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        datetime: document.getElementById('datetime').value,
        color: document.getElementById('color').value,
        consistency: document.getElementById('consistency').value
      };

      // Read custom fields
      customFields.forEach((field) => {
        const elemId = `custom-${field.name}`;
        if (field.type === 'text') {
          entry[field.name] = document.getElementById(elemId)?.value;
        } else if (field.type === 'select') {
          entry[field.name] = document.getElementById(elemId).value;
        } else if (field.type === 'multiselect') {
          entry[field.name] = getMultiSelectValues(elemId);
        }
      });

      // 1) Check if a duplicate exists
      const isDupe = poopEntries.some((existing) => {
        if (existing.datetime !== entry.datetime) return false;
        if (existing.color !== entry.color) return false;
        if (existing.consistency !== entry.consistency) return false;
        // Check each custom field
        for (const f of customFields) {
          // Convert to JSON strings for deep comparison
          const newVal = JSON.stringify(entry[f.name] ?? null);
          const oldVal = JSON.stringify(existing[f.name] ?? null);
          if (newVal !== oldVal) return false;
        }
        return true;
      });
      if (isDupe) {
        showNotification('This entry already exists!');
        return;
      }

      // 2) If not a duplicate, save the new entry
      poopEntries.push(entry);
      localStorage.setItem('poopEntries', JSON.stringify(poopEntries));

      // 3) Reset the form
      document.getElementById('poop-form').reset();
      // Also reset multi-select labels
      customFields.forEach((field) => {
        if (field.type === 'multiselect') {
          const elemId = `custom-${field.name}`;
          const containerId = `${elemId}-multiContainer`;
          const optionsId = `${elemId}-multiOptions`;
          document.getElementById(`${containerId}-labels`).textContent = 'Select options';
          const opts = document
            .getElementById(optionsId)
            .querySelectorAll('input[type="checkbox"]');
          opts.forEach((o) => (o.checked = false));
        }
      });

      showNotification('Poop saved successfully!');
      updateRecentPoops(); // Immediately refresh last 5
    }

    function deletePoopEntry(id) {
      const ok = confirm('Are you sure you want to delete this entry?');
      if (!ok) return;
      poopEntries = poopEntries.filter((e) => e.id !== id);
      localStorage.setItem('poopEntries', JSON.stringify(poopEntries));
      showNotification('Poop entry deleted.');
      updateRecentPoops();
      renderCalendar(); // refresh calendar if on that page
      closeDayModal(); // if open, close it so it doesn't show stale data
    }

    function updateRecentPoops() {
      const recentPoopsContainer = document.getElementById('recent-poops-list');
      recentPoopsContainer.innerHTML = '';
      // Sort by datetime desc
      const sorted = [...poopEntries].sort(
        (a, b) => DateTime.fromISO(b.datetime) - DateTime.fromISO(a.datetime)
      );
      const lastFive = sorted.slice(0, 5);

      if (lastFive.length === 0) {
        recentPoopsContainer.innerHTML = 'No entries yet.';
        return;
      }

      lastFive.forEach((entry) => {
        const div = document.createElement('div');
        div.className = 'poop-item';
        const date = DateTime.fromISO(entry.datetime).toFormat('MMM dd HH:mm');
        div.innerHTML = `
          <div class="poop-info">
            ${date} - Color: ${entry.color}, Consistency: ${entry.consistency}
          </div>
          <button style="background:#2196F3" onclick="openEditPoop('${entry.id}')">Edit</button>
          <button style="background:#f44336" onclick="deletePoopEntry('${entry.id}')">Delete</button>
        `;
        recentPoopsContainer.appendChild(div);
      });
    }

    // --------------------------------
    // EDIT POOP
    // --------------------------------
  
    function openEditPoop(id) {
      editingPoopId = id;
      const poop = poopEntries.find((p) => p.id === id);
      if (!poop) return;

      // Build the same form structure as "create"
      const editForm = document.getElementById('edit-poop-form');
      editForm.innerHTML = '';

      // Date/Time
      const dtGroup = document.createElement('div');
      dtGroup.className = 'form-group';
      dtGroup.innerHTML = `
        <label>Date/Time</label>
        <input type="datetime-local" id="edit-datetime" />
      `;
      editForm.appendChild(dtGroup);

      // Color
      const colorGroup = document.createElement('div');
      colorGroup.className = 'form-group';
      colorGroup.innerHTML = `
        <label>Color</label>
        <select id="edit-color">
          <option value="brown">Brown</option>
          <option value="green">Green</option>
          <option value="yellow">Yellow</option>
          <option value="black">Black</option>
          <option value="red">Red</option>
        </select>
      `;
      editForm.appendChild(colorGroup);

      // Consistency
      const consGroup = document.createElement('div');
      consGroup.className = 'form-group';
      consGroup.innerHTML = `
        <label>Consistency (Bristol Stool Scale)</label>
        <select id="edit-consistency">
          <option value="1">Type 1 - Separate hard lumps</option>
          <option value="2">Type 2 - Lumpy sausage</option>
          <option value="3">Type 3 - Sausage with cracks</option>
          <option value="4">Type 4 - Smooth sausage</option>
          <option value="5">Type 5 - Soft blobs</option>
          <option value="6">Type 6 - Mushy</option>
          <option value="7">Type 7 - Liquid</option>
        </select>
      `;
      editForm.appendChild(consGroup);

      // Custom fields
      customFields.forEach((field) => {
        const elementIdPrefix = `edit-custom-${field.name}`;
        const divEl = createFieldElement(field, elementIdPrefix, true);
        editForm.appendChild(divEl);
      });

      // Save button
      const btnGroup = document.createElement('div');
      btnGroup.className = 'form-group';
      btnGroup.innerHTML = `<button onclick="saveEditedPoop()">Save Changes</button>`;
      editForm.appendChild(btnGroup);

      // Pre-fill form with existing data
      document.getElementById('edit-datetime').value = DateTime.fromISO(
        poop.datetime
      ).toFormat("yyyy-MM-dd'T'HH:mm");
      document.getElementById('edit-color').value = poop.color;
      document.getElementById('edit-consistency').value = poop.consistency;

      // For custom fields
      customFields.forEach((field) => {
        const val = poop[field.name];
        if (val !== undefined) {
          const elemId = `edit-custom-${field.name}`;
          if (field.type === 'text') {
            document.getElementById(elemId).value = val;
          } else if (field.type === 'select') {
            document.getElementById(elemId).value = val;
          } else if (field.type === 'multiselect') {
            // val is array
            const containerId = `${elemId}-multiContainer`;
            const optionsId = `${elemId}-multiOptions`;
            const checkboxes = document
              .getElementById(optionsId)
              .querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach((c) => {
              c.checked = val.includes(c.value);
            });
            updateMultiSelectLabel(containerId, optionsId);
          }
        }
      });

      // Show modal
      document.getElementById('edit-poop-modal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('edit-poop-modal').classList.remove('active');
    }

    function editModalBackgroundClick(e) {
      if (e.target.id === 'edit-poop-modal') {
        closeEditModal();
      }
    }

    function saveEditedPoop() {
      if (!editingPoopId) return;
      const poop = poopEntries.find((p) => p.id === editingPoopId);
      if (!poop) return;

      // Update fields
      poop.datetime = document.getElementById('edit-datetime').value;
      poop.color = document.getElementById('edit-color').value;
      poop.consistency = document.getElementById('edit-consistency').value;

      // Custom fields
      customFields.forEach((field) => {
        const elemId = `edit-custom-${field.name}`;
        if (field.type === 'text') {
          poop[field.name] = document.getElementById(elemId)?.value;
        } else if (field.type === 'select') {
          poop[field.name] = document.getElementById(elemId).value;
        } else if (field.type === 'multiselect') {
          poop[field.name] = getMultiSelectValues(elemId);
        }
      });

      localStorage.setItem('poopEntries', JSON.stringify(poopEntries));
      showNotification('Poop updated successfully!');

      closeEditModal();
      updateRecentPoops();
      renderCalendar();
      closeDayModal(); // if day modal was open, we close it so user can see fresh data
    }

    // --------------------------------
    // CALENDAR
    // --------------------------------
    function renderCalendar() {
      const start = currentMonth.startOf('month');
      const end = currentMonth.endOf('month');
      const daysInMonth = end.day;

      document.getElementById('current-month').textContent =
        currentMonth.toFormat('MMMM yyyy');

      const calContainer = document.getElementById('calendar-view');
      calContainer.innerHTML = '';

      // Empty days (padding before 1st day)
      for (let i = 0; i < start.weekday - 1; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'day';
        calContainer.appendChild(emptyDiv);
      }

      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = currentMonth.set({ day });
        const dateString = currentDate.toISODate();
        const entries = poopEntries.filter(
          (e) => DateTime.fromISO(e.datetime).toISODate() === dateString
        );
        const isToday = currentDate.hasSame(DateTime.now(), 'day');

        const dayDiv = document.createElement('div');
        dayDiv.className = `day ${isToday ? 'current-day' : ''}`;
        dayDiv.innerHTML = `<div class="day-header">${day}</div>`;

        entries.forEach((entry) => {
          const indicator = document.createElement('div');
          indicator.className = 'poop-indicator';
          indicator.style.backgroundColor = getColorCode(entry.color);
          dayDiv.appendChild(indicator);
        });
        dayDiv.onclick = () => openDayModal(dateString);

        calContainer.appendChild(dayDiv);
      }
    }

    function changeMonth(offset) {
      currentMonth = currentMonth.plus({ months: offset });
      renderCalendar();
    }

    // --------------------------------
    // DAY MODAL
    // --------------------------------
    function openDayModal(dateString) {
      const modal = document.getElementById('day-modal');
      modal.classList.add('active');

      const dateObj = DateTime.fromISO(dateString);
      document.getElementById('day-modal-title').textContent = dateObj.toFormat(
        'MMMM dd, yyyy'
      );

      const dayEntries = poopEntries
        .filter((e) => DateTime.fromISO(e.datetime).toISODate() === dateString)
        .sort(
          (a, b) =>
            DateTime.fromISO(a.datetime).valueOf() -
            DateTime.fromISO(b.datetime).valueOf()
        );

      const body = document.getElementById('day-modal-body');
      body.innerHTML = '';

      if (dayEntries.length === 0) {
        body.innerHTML = '<p>No entries for this day.</p>';
        return;
      }

      dayEntries.forEach((entry) => {
        const timeStr = DateTime.fromISO(entry.datetime).toFormat('HH:mm');
        let customHtml = '';
        customFields.forEach((f) => {
          const val = entry[f.name];
          if (val !== undefined && val !== '') {
            if (Array.isArray(val)) {
              customHtml += `<div><strong>${f.name}:</strong> ${val.join(', ')}</div>`;
            } else {
              customHtml += `<div><strong>${f.name}:</strong> ${val}</div>`;
            }
          }
        });

        const div = document.createElement('div');
        div.style.borderBottom = '1px solid #eee';
        div.style.padding = '0.5rem 0';
        div.innerHTML = `
          <div><strong>Time:</strong> ${timeStr}</div>
          <div><strong>Color:</strong> ${entry.color}, <strong>Consistency:</strong> ${entry.consistency}</div>
          ${customHtml}
          <button style="background:#2196F3" onclick="openEditPoop('${entry.id}')">Edit</button>
          <button style="background:#f44336" onclick="deletePoopEntry('${entry.id}')">Delete</button>
        `;
        body.appendChild(div);
      });
    }

    function closeDayModal() {
      document.getElementById('day-modal').classList.remove('active');
    }

    function modalBackgroundClick(e) {
      if (e.target.id === 'day-modal') {
        closeDayModal();
      }
    }

    // --------------------------------
    // ANALYSIS
    // --------------------------------
    function updateAnalysis() {
      // Update stats
      document.getElementById('total-entries').textContent = poopEntries.length;
      // (Rough daily average over last 30 days)
      document.getElementById('daily-average').textContent = (
        poopEntries.length / 30
      ).toFixed(1);

      // Most common color
      const colorCounts = poopEntries.reduce((acc, { color }) => {
        acc[color] = (acc[color] || 0) + 1;
        return acc;
      }, {});
      document.getElementById('common-color').textContent =
        Object.entries(colorCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';

      // Most common consistency
      const consistencyCounts = poopEntries.reduce((acc, { consistency }) => {
        acc[consistency] = (acc[consistency] || 0) + 1;
        return acc;
      }, {});
      document.getElementById('common-consistency').textContent =
        Object.entries(consistencyCounts).sort((a, b) => b[1] - a[1])[0]?.[0] ||
        '-';

      // Update charts
      updateChart(
        'consistencyChart',
        'pie',
        {
          labels: ['1', '2', '3', '4', '5', '6', '7'],
          data: Array(7)
            .fill()
            .map(
              (_, i) =>
                poopEntries.filter((e) => e.consistency === String(i + 1)).length
            )
        },
        'Consistency Distribution'
      );

      updateChart(
        'timeChart',
        'bar',
        {
          labels: Array(24)
            .fill()
            .map((_, i) => `${i}:00`),
          data: Array(24)
            .fill()
            .map(
              (_, hour) =>
                poopEntries.filter(
                  (e) => DateTime.fromISO(e.datetime).hour === hour
                ).length
            )
        },
        'Time Distribution'
      );

      // Custom Attributes Analysis
      renderCustomAttributeCharts();
    }

    function updateChart(chartId, type, { labels, data }, label) {
      if (charts[chartId]) charts[chartId].destroy();
      charts[chartId] = new Chart(document.getElementById(chartId), {
        type,
        data: {
          labels,
          datasets: [
            {
              label,
              data,
              backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40',
                '#EB5757'
              ]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // Create bar charts for each custom attribute with finite options
    function renderCustomAttributeCharts() {
      const container = document.getElementById('custom-attribute-charts');
      container.innerHTML = '';

      customFields.forEach((field) => {
        if (field.type === 'text') {
          // skip text because infinite possible values
          return;
        }
        // We'll do a bar chart for single or multi-select
        const wrapper = document.createElement('div');
        wrapper.className = 'chart-container';
        const canvas = document.createElement('canvas');
        const chartId = `custom-chart-${field.name}`;
        canvas.id = chartId;
        wrapper.appendChild(canvas);
        container.appendChild(wrapper);

        // Count usage
        const counts = {};
        field.options.forEach((opt) => {
          counts[opt] = 0;
        });

        poopEntries.forEach((e) => {
          const val = e[field.name];
          if (val !== undefined) {
            if (Array.isArray(val)) {
              // multi
              val.forEach((v) => {
                if (counts[v] !== undefined) {
                  counts[v]++;
                }
              });
            } else {
              // single
              if (counts[val] !== undefined) {
                counts[val]++;
              }
            }
          }
        });

        const labels = Object.keys(counts);
        const data = labels.map((l) => counts[l]);

        charts[chartId] = new Chart(canvas, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: field.name,
                data,
                backgroundColor: '#36A2EB'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      });
    }

    // --------------------------------
    // IMPORT/EXPORT
    // --------------------------------
    function exportData() {
      const data = {
        customFields,
        poopEntries
      };
      const dataStr =
        'data:text/json;charset=utf-8,' +
        encodeURIComponent(JSON.stringify(data, null, 2));
      const dlAnchor = document.createElement('a');
      dlAnchor.setAttribute('href', dataStr);
      dlAnchor.setAttribute('download', 'poop-tracker-data.json');
      dlAnchor.click();

      showNotification('Data exported!');
    }

    function importData() {
      const fileInput = document.getElementById('importFile');
      if (!fileInput.files.length) {
        showNotification('No file selected!');
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (importedData.customFields && importedData.poopEntries) {
            customFields = importedData.customFields;
            // Migrate any old "radio"
            customFields.forEach((f) => {
              if (f.type === 'radio') {
                f.type = 'select';
              }
            });

            poopEntries = importedData.poopEntries;
            // ensure IDs
            poopEntries.forEach((entry) => {
              if (!entry.id) {
                entry.id =
                  Date.now().toString() + Math.random().toString(16).slice(2);
              }
            });

            localStorage.setItem('customFields', JSON.stringify(customFields));
            localStorage.setItem('poopEntries', JSON.stringify(poopEntries));
            showNotification('Data imported successfully!');

            renderCustomFields();
            renderSettingsPage();
            updateRecentPoops(); // refresh track page list
            renderCalendar();    // refresh calendar
          } else {
            showNotification('Invalid data format.');
          }
        } catch (err) {
          showNotification('Error parsing JSON file.');
        }
      };
      reader.readAsText(file);
    }

    // --------------------------------
    // UTILITY
    // --------------------------------
    function getColorCode(color) {
      const colors = {
        brown: '#795548',
        green: '#4CAF50',
        yellow: '#FFEB3B',
        black: '#212121',
        red: '#F44336'
      };
      return colors[color] || '#9E9E9E';
    }

    // Custom toast notifications
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 2500); // 2.5s as requested
    }

    // --------------------------------
    // INITIALIZE
    // --------------------------------
    // Set default datetime
    document.getElementById('datetime').value = DateTime.now().toFormat(
      "yyyy-MM-dd'T'HH:mm"
    );

    // Render track page items on load
    renderCustomFields();
    updateRecentPoops();

    // Request notification permission for reminders
    if (Notification.permission !== 'denied') {
      Notification.requestPermission().then((perm) => {
        if (perm === 'granted') {
          new Notification('Poop Tracker Ready!', {
            body: 'You will receive daily reminders to log your poops!'
          });
        }
      });
    }

    // Reminder check every hour
    setInterval(() => {
      const today = DateTime.now().toISODate();
      const hasEntry = poopEntries.some(
        (e) => DateTime.fromISO(e.datetime).toISODate() === today
      );

      if (!hasEntry && Notification.permission === 'granted') {
        new Notification('Poop Tracking Reminder', {
          body: "Don't forget to log today's bowel movements!"
        });
      }
    }, 3600000);
  </script>
</body>
</html>
